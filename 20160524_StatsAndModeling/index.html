<!DOCTYPE html>
<html>
  <head>
    <title>Statistics and Modeling with City Data - Center for Government Excellence</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../slide.css"/>
  </head>
  <body>
    <textarea id="source">

layout:true

<p class="footer">
<span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Statistics and Modeling with City Data</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://www.datapolitan.com" property="cc:attributionName" rel="cc:attributionURL">Richard Dunks</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative-Commons-License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a>
</p>

---

class:center,middle
#Statistics and Modeling with City Data

- - - 

##Richard Dunks
###Follow along at: http://bit.ly/GovEx-Stats

![img-center-40](../images/datapolitan.png)

---

class:center,middle
[![img-full](http://www.vancitybuzz.com/wp-content/uploads/2014/10/Cookie__say_hi_by_lovestrike_large.jpg)](http://www.vancitybuzz.com/wp-content/uploads/2014/10/Cookie__say_hi_by_lovestrike_large.jpg)

---

#Goals
--

+ Review descriptive statistics
--

+ Review how to calculate descriptive statistics in Excel
--

+ Review correlations and calculating coefficients of correlation in Excel
--

+ Review linear regression and calculate best fit line in Excel
--

+ Discuss supervised and unsupervised learning
--

+ Introduce the concept of clustering and demonstrate clustering in Excel

---

#Outcomes
--

+ You will be more familiar with descriptive statistics and how to calculate them in Excel
--

+ You will be more familiar with coefficients of correlation and how to calculate them in Excel
--

+ You will better understand linear regression and how to calculate a line of best fit in Excel

---

#Outcomes
+ You will better understand supervised and unsupervised learning
--

+ You will better understand the concept of distance and similarity in machine learning
--

+ You will better understand clustering and how to cluster features in Excel


---

class:center,middle
#(Re-)Introduction to Statistics

---
class:center,middle
> We are drowning in information and starving for knowledge.

##Rutherford D. Roger

---

#Why Statistics?
--

+ Tools for extracting meaning from data
--

+ Commonly understood ways of communicating meaning to others

---

#Histogram
--

+ Charts the frequency of instances in the data
--

+ Shows the frequency distribution
--

+ Values are grouped into class intervals
--

+ Best to have a consistent size to class intervals

--

![img-left-45](../images/hist1.png)
--

![img-right-45](../images/hist2.png)

<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
######Source: http://mathematica.stackexchange.com/questions/59520/histogram-with-variable-bin-size

---

class:center,middle
#Distributions of Data

---

#Normal Distribution
![img-center-100](../images/dist_normal_pov.png)

---

#Long-tail Distribution
![img-center-95](../images/dist_lt_pop.png)

---

#Bi-Modal Distribution
![img-center-90](../images/dist_bm.png)


---

class:center,middle
#Describing Data

---

#Mean
--

+ A representative value for the data
--

+ Usually what people mean by “average”
--

+ Calculate by adding all the values together and dividing by the number instances
--

+ Sensitive to extremes

---

#Median
--

+ The “middle” value of a data set
--

+ Center value of a data set with an odd number of values
--

+ Sum of two middle values divided by 2 if the number of items in a data set is even
--

+ Resistant to extreme values
--

![img-full](../images/median_balance.png)

---

#Median vs Mean
![img-center-80](https://upload.wikimedia.org/wikipedia/commons/d/de/Comparison_mean_median_mode.svg)

By Cmglee (Own work) [<a href="http://creativecommons.org/licenses/by-sa/3.0">CC BY-SA 3.0</a> or <a href="http://www.gnu.org/copyleft/fdl.html">GFDL</a>], <a href="https://commons.wikimedia.org/wiki/File%3AComparison_mean_median_mode.svg">via Wikimedia Commons</a>
---

#Mode
--

+ The most frequent value in a dataset
--

+ Not often used
--

![img-center-50](../images/mode.png)

---

#Measures of Central Tendency
--

+ Quantitative data tends to cluster around some central value
--

+ Contrasts with the spread of data around that center (i.e. the variability in the data)
--

+ Mean is a more precise measure and more often used
--

+ Median is better when there are extreme outliers
--

+ Mode is used to describe the most frequent value

---

class:center,middle
#Let's do this in Excel
##What is the mean time a [311 noise-related service request](../data/20150601_20150830_311_Noise.csv) remains open? The median? The mode?
##How does this look by agency?

---

#Preparing the Data
![img](../images/311_prep1.png)

---

![img](../images/311_prep2.png)

---

#Preparing the Data
![img](../images/311_prep3.png)

---

#Preparing the Data
![img](../images/311_prep4.png)

---

class:center,middle
#Enabling the Data Analysis Toolpak in Office 2016 for Mac

---

#Enable Add-Ins
![img-left-30](../images/datp_mac1.png)
--
![img-right-60](../images/datp_mac2.png)

---

#Restart Excel

![img-center-bottom-70](../images/datp_mac3.png)

###[More detailed instructions](https://support.office.com/en-us/article/Load-the-Analysis-ToolPak-in-Excel-2016-for-Mac-617afc33-4af8-4530-b132-7b4e938890d0?ui=en-US&rs=en-US&ad=US&fromAR=1)

---

#Descriptive Statistics in Excel 2013/2016
![img-center-70](../images/datp_summary1.png)

---

#Descriptive Statistics in Excel 2013/2016
![img-center-70](../images/datp_summary2.png)

---

#Descriptive Statistics in Excel 2013/2016
![img-center-30](../images/datp_summary3.png)


---

class:center,middle
#Measuring Variability

---

#Range
--

+ The gap between the minimum value and the maximum value
--

+ Calculated by subtracting the minimum from the maximum

--

![img](../images/311_calc_min.png)

--

![img](../images/311_calc_max.png)

--

![img-center-30](../images/311_calc_range.png)
---

#Quartiles
--

+ Median splits the data set into two equal groups
--

+ Quartiles split the data into four equal groups
--

+ First quartile is 0-25% of the data
--

+ Second quartile is 25-50% of the data
--

+ Third quartile is 50-75% of the data
--

+ Fourth quartile is 75-100% of the data

---

[![img-center-80](../images/quartile_help.png)](https://support.office.com/en-us/article/QUARTILE-function-93cf8f62-60cd-4fdb-8a92-8451041e1a2a)

---

#Calculating Quartiles

--

![img-full](../images/311_calc_q1.png)

--

![img-full](../images/311_calc_q3.png)

---

#Interquartile Range
--

+ “Middle” 50% of data (between 1st Quartile and 3rd Quartile)
--

![img-center-large](../images/iqr.png)

---

#Calculate IQR
![img](../images/311_calc_iqr.png)

---

#Outliers
--

+ Any data points less than 1.5x the IQR or greater than 1.5x the IQR are considered outliers
--

+ Helps identify data points that may skew the analysis
--

+ Focus on the “meat” of the data

---

#Outliers
![img-center-35](../images/outlier.png)
http://flowingdata.com/2008/02/15/how-to-read-and-use-a-box-and-whisker-plot/ 

---

#Standard Deviation
--

+ The average distance of each data point from the mean
--

![img-center-50](../images/stdev_formula.png)
--

+ Larger the standard deviation, the greater the spread
--

![img-full](../images/std1.png)

---

#Standard Deviation
+ Very sensitive to extremes
--

+ Best to use with normally distributed data

---

#Calculating Standard Deviation in Excel
![img-full](../images/311_calc_stdev.png)

---

#Measures of Variability
--

+ Describe the distribution of our data
--

+ Range (Maximum – Minimum)
--

+ Inter-quartile Range
--

+ Standard Deviation
--

+ Identification of outliers (1.5 x IQR)

---

#Histograms in Excel 2013/2016

--

+ Think we can use PivotTables?
--

+ No
--

+ Need to use the Data Analysis Toolpak

---

#Create Bins
![img-center-45](../images/2015_hist1.png)

---

#Open Data Analysis Toolpak
![img-center-55](../images/2015_hist2.png)

--

![img-center-55](../images/2015_hist3.png)

---

#Results
![img-left-40](../images/2015_hist4.png)

--

![img-right-50](../images/2015_hist4a.png)

--
#&nbsp;
![img-right-35](../images/2015_hist5.png)

---

class:center,middle
#Bi-variate Analysis

---

#Correlations
![img-full](../images/corr1.png)
###How do we measure this relationship?

---

#Coefficient of Correlation
--

+ Quantifies the amount of shared variability between variables
--

+ Ranges between -1 and +1 
--

+ Negative numbers are inversely proportional
--

+ Positive numbers are directly proportional
--

+ The closer to either -1 or +1, the greater the correlation

---

#Coefficient of Correlation
![img-full](../images/corr3.png)
http://www.statisticshowto.com/what-is-the-correlation-coefficient-formula/

---

#Coefficient of Correlation
![img-center-80](../images/corr2.png)

http://pixshark.com/correlation-examples.htm 

---

#Correlations - Height and Weight
![img-full](../images/corr1.png)
[Download the data](https://github.com/datapolitan/CenterForGovernmentExcellence/blob/gh-pages/data/height_weight.xlsx?raw=true)

---

![img-full](../images/calc_corr.png)

---
#Or we could use Excel
![img-center-large](../images/corr7.png)


---

#Correlations - Recycling and Median Income
![img](../images/corr6.png)
###These are even slightly more correlated (r=0.88478) [Check it yourself](https://github.com/datapolitan/CenterForGovernmentExcellence/blob/gh-pages/data/2013_NYC_CD_MedianIncome_Recycle.xlsx?raw=true)

http://iquantny.tumblr.com/post/79846201258/the-huge-correlation-between-median-income-and

---

#Correlations
![img-center-large](../images/corr4.png)

---

#Correlations
![img-full](../images/corr5.png)

---

#Correlations
![img-full](../images/corr5.png)
##Correlation does not imply causation


---

class:middle,center
#Predictive Modeling

---

#Prediction
--

+ Knowing the relationship between variables (i.e. the correlation), we can predict values based on the relationship
--

+ Can estimate the magnitude as well as the general trend
--

+ More data points, the better the prediction
--

+ Example -> Knowing the relationship between median income and recycling rates, what can we predict about recycling rates as median incomes grow in communities?

---

#Linear Regression
--

+ Using the known relationship between continuous variables, we can predict unseen values
--

+ Assumes relationship is linear

---

#Formula for a line
![img](../images/lr1.png)
#####http://www.algebra-class.com/slope-formula.html 

---

#Formula for a line
![img](../images/lr2.png)
#####http://www.mathwarehouse.com/algebra/linear_equation/slope-of-a-line.php

---

#Formula for a line
--

+ Draw a line that minimizes the distance between each point
--

+ “Line of best fit” -> minimizes the sum of squared residuals

--

![img](../images/lr3.png)
#####http://nbviewer.ipython.org/github/justmarkham/DAT4/blob/master/notebooks/08_linear_regression.ipynb

---

#Linear Regression
--

+ Characteristics of the line defines the relationship
--

+ Slope -> relationship between independent and dependent variable (how Y increases per unit of X)
--

+ Intercept -> expected mean value of Y at X=0
--

+ Values along the line are the predicted values for any given value X

---

#Displaying a Trendline in Excel
![img-left-40](../images/lr4.png)
--
![img-right-50](../images/lr5.png)

---

#Calculating coefficients in Excel
![img-full](../images/lr6.png)

---

#Calculating coefficients in Excel
![img-full](../images/lr7.png)

---

#Calculating coefficients in Excel
![img-full](../images/lr8.png)

---

#Linear Regression Line
![img](../images/lr9.png)

--

###RecyclingRate = 0.0000001869 * MedianIncome + 0.07480414
---

#What is this telling us?
###RecyclingRate = 0.0000001869 * MedianIncome + 0.07480414
--

+ Every dollar increase in median income will increase the recycling rate by about 0.0000001869
--

+ If the median income was zero, the recycling rate would be about 0.07480414

---

class:center,middle
#We've created a model to make predictions!
##&nbsp;
#&nbsp;

---

class:center,middle
#We've created a model to make predictions!
##&nbsp;
#The predictions are just not very good

---

class:center,middle
![img-full](../images/data_meme.png)

---

class:center,middle
![img-center-80](../images/big-data-meme-star-trek.jpg)

---

#How is Linear Regression Useful in Cities?
--

+ Make predictions
--

+ Identify outliers

---

#Multiple Linear Regression
--

+ We can perform a regression using multiple variables
--

+ Two or more independent variables 
--

+ One dependent variable
--

+ The best fit line becomes a plane
--

+ Multiple linear regression in Excel is possible using the same method we just used
--

######http://cameron.econ.ucdavis.edu/excel/ex61multipleregression.html

---

#Multiple Linear Regression

![img-center-55](../images/mlr.jpg)

#####Source: http://gerardnico.com/wiki/data_mining/multiple_regression [CC Attribution-Noncommercial-Share Alike 3.0 Unported](http://creativecommons.org/licenses/by-nc-sa/3.0/)

---

# Supervised Learning
--

+ The target value (y) is known in advance
--

+ We use the relationship between the features (x) and the target value for instances where y is known to create a predictor for instances where y isn’t known

---

#Types of Supervised Learning Algorithms
--

+ Linear regression
--

+ Decision trees
--

+ Neural Networks

---

class:center,middle
#10 Min Break
![img-full](https://imgs.xkcd.com/comics/correlation.png)
http://xkcd.com/552/ 

---

#Unsupervised Learning

[![img-center-90](http://www.dumpaday.com/wp-content/uploads/2012/12/funny-quotes-i-know-i-am-unsupervised.jpg)](http://www.dumpaday.com/funny-pictures/funny-pictures-of-the-day-47-pics/attachment/funny-quotes-i-know-i-am-unsupervised/)

---

#Unsupervised Learning
--

+ Finding hidden structure in unlabeled data
--

+ Don’t know the target variable we’re trying to predict
--

+ Allow the algorithm to decide what value to give the data
--

+ Requires much more tuning and development
--

+ No good way of measuring success

---

#Clustering
+ Finding groups of objects similar to one another and different from the objects in other groups

![img](../images/cluster1.png)

---

#Sounds simple, right?

--

![img-center-80](../images/cluster2.png)

---

![img-center-80](http://www.brookings.edu/~/media/Blogs/The-Avenue/2016/05/18-inclusive/Cluster_Map_II-vertical.jpg)

---

[![img-center-90](../images/brookings.png)](http://www.brookings.edu/blogs/the-avenue/posts/2016/05/18-metro-map-inclusive-economies-berube-marchio-ng-shearer)

Source: http://www.brookings.edu/blogs/the-avenue/posts/2016/05/18-metro-map-inclusive-economies-berube-marchio-ng-shearer

---

[![img-center-90](../images/brookings_box.png)](http://www.brookings.edu/blogs/the-avenue/posts/2016/05/18-metro-map-inclusive-economies-berube-marchio-ng-shearer)

Source: http://www.brookings.edu/blogs/the-avenue/posts/2016/05/18-metro-map-inclusive-economies-berube-marchio-ng-shearer
---

class:center,middle
![img-center-100](../images/brookings2.png)

Source: https://app.box.com/shared/static/aqkae0ephkuygfvpnxfbknf1irvq1cqg.pdf

---

class:center,middle
#There's a few things we need to talk about...

---

class:center,middle
![img-center-100](../images/data_prep.png)

---

class:center,middle
#We need to encode attributes (qualitative and quantitative) into representations that are easily understood by machine learning algorithms

---

#Feature Engineering
![img-center-90](../images/sim1.png)

---

#Feature Engineering
![img-center-90](../images/sim2.png)

---

#Feature Engineering
![img-center-90](../images/sim3.png)

---

class:center,middle
![img-center-100](../images/feed_machine.png)

---

# Feature Engineering - The Importance
> ##Actually the success of all machine learning algorithms depends on how you present the data.  
> + Mohammad Pezeshki

http://www.quora.com/What-are-some-general-tips-on-feature-selection-and-engineering-that-every-data-scientist-should-know

---

#Feature Engineering - A Definition
> ##The process of transforming raw data into features that better represent the underlying problem to the predictive models, resulting in improved model accuracy on unseen data

http://machinelearningmastery.com/discover-feature-engineering-how-to-engineer-features-and-how-to-get-good-at-it/
---

#Feature Engineering - Important Factors
--

+ The data you’re using
--

+ The domain you’re working in
--

+ The models you’re working with

---

# Feature Engineering - Strategies
--

+ Use integers to encode features

![img-center-80](../images/feature1.png)
--

+ Discretize continuous values
--

+ Create dummy variables (but be sure to leave one out)

---

#Feature Engineering - Keep In Mind
--

+ Choices made will impact the results
--

+ It's more an art than a science

---

#Cities mapped by population and income
![img-center-80](../images/cities_mapped.png)

--
###Each city has a location in space based on their attributes<br>Based on their [Percentile Rank](https://support.office.com/en-us/article/PERCENTRANK-function-f1b5836c-9619-4847-9fc9-080ec9024442)

---

##Relative distance between points is their similarity
![img-center-50](../images/dist1.png)
--

###South Bend, IN and Erie, PA<br>`√((0.021-0.014)^2 + (0.09-0.07)^2))≈0.021`
--

###Erie, PA and College Station, TX<br>`√((0.014-0.003)^2 + (0.07-0.04)^2))≈0.032`
--

###Erie, PA is more similar to South Bend, IN than College Station, TX by this measure (but they're more similar than to more distant points)

---

#Similarity
+ These look similar
![img-center-90](../images/sim1.png)

---

#Similarity
+ These are quantifiably more similar
![img-center-100](../images/sim4.png)

---

#Features
--

+ Each feature is a dimension of the data
--

+ 100 Features means 100 dimensions
--

![img](http://i.giphy.com/NbgeJftsErO5q.gif)

---

#Calculating Distance
--

+ We can use Euclidean distance (like in the example)
--

+ But there are others (we just won't be talking about them)

---

class:center,middle
#Back to Clustering

![img](../images/cluster1.png)

---

#Clustering
--

+ We can map our features
--

+ We can calculate distance
--

+ The next step is to find clusters of points

---

#Clustering - How it works
+ Set the number of clusters you think there are (say 3)

![img](../images/cluster3.png)

---

#Clustering - How it works
+ Randomly select cluster centers in the feature space

![img](../images/cluster4.png)

---

#Clustering - How it works
+ Assign points to the nearest cluster center

![img](../images/cluster5.png)

---

#Clustering - How it works
+ Shift center points to center of cluster

![img](../images/cluster6.png)

---

#Clustering - How it works
+ Reassign cluster assignments
+ Shift cluster centers to be more central

![img](../images/cluster7.png)

---

#Clustering - How it works
+ Repeat -> stop when too few points change clusters


![img](../images/cluster8.png)

---

class:center, middle
#Let's cluster some cities
##&nbsp;<br>&nbsp;<br>&nbsp;
---

class:center, middle
#Let's cluster some cities
##Disclaimer: I don't think these features are optimal for analyzing this dataset, but they demonstrate the principles I'm trying to show you

---

class:center
![img-center-40](../images/warning.png)
##Math, Formulas, and Functions Ahead
##Proceed at your own risk!
###Try and follow along as best you can

---

#Prepare the data
+ Create a new column

![img-center-100](../images/cluster_prep1.png)

---

#Prepare the data
+ Calculate whether the city has a population above the 75th percentile (above 3rd quartile)

![img-center-100](../images/cluster_prep2.png)

##`=IF(C2>QUARTILE(C$2:C$287,3),1,0)`

---

#Prepare the data
+ Calculate whether the city has a population growth above the 75th percentile (above 3rd quartile)

![img-center-90](../images/cluster_prep3.png)

##`=IF(E2>QUARTILE(E$2:E$287,3),1,0)`

---

#Prepare the data
+ Indicate whether the city participated in the Mayor's Challenge

![img-center-90](../images/cluster_prep4.png)

##`=IF(OR(G2="Applied",G2="Semifinalist",G2="Finalist",G2="Grand Prize Winner"),1,0)`

---

#Prepare the data
+ Indicate whether the city has an open data portal/law

![img-center-80](../images/cluster_prep5.png)

##`=IF(AND(I2<>"None",NOT(ISBLANK(I2))),1,0)`
###[NOT Function](https://support.office.com/en-us/article/NOT-function-9cfc6011-a054-40c7-a140-cd4ba2d87d77) / [ISBLANK Function](https://support.office.com/en-us/article/IS-functions-0f2d7971-6019-40a0-a171-f2d869135665)

---

#Prepare the data
+ Indicate whether the government is a Council-Manager

![img-center-80](../images/cluster_prep6.png)

##`=IF(K2="Council-Manager",1,0)`

---

#Prepare the data
+ Indicate whether the mayor is a Republican

![img-center-60](../images/cluster_prep7.png)

##`=IF(M2="R",1,0)`<br>
--
This is a dummy variable (and I'm not making a joke)

---

#Prepare the data
+ Indicate whether the mayor's party is 'Other'

![img-center-60](../images/cluster_prep8.png)

##`=IF(AND(M2<>"R",M2<>"D"),1,0)`<br>
--
Notice we're leaving one out (Mayor is a Democrat)

---

#Prepare the data
+ Calculate whether the city has a median income above the 75th percentile (above 3rd quartile)

![img-center-60](../images/cluster_prep9.png)

##`=IF(P2>QUARTILE($P$2:$P$287,3),1,0)`

---

#Prepare the data
+ Calculate whether the city has a poverty rate above the 75th percentile (above 3rd quartile)

![img-center-60](../images/cluster_prep10.png)

##`=IF(R2>QUARTILE($R$2:$R$287,3),1,0)`

---

#Prepare the data
+ Calculate whether the city has a non-white population above the 75th percentile (above 3rd quartile)

![img-center-60](../images/cluster_prep11.png)

##`=IF(T2>QUARTILE($T$2:$T$287,3),1,0)`

---

#Prepare the data
+ Code the regions West, Midwest, South

![img-center-60](../images/cluster_prep12.png)

##`=IF(V2="West",1,0)`

---

#Prepare the data
+ Copy the sheet in the same workbook
+ Copy all the cells and paste values only
+ Delete the columns you didn't just create

![img-center-100](../images/matrix.png)

---

#Prepare the data
+ Copy the cells and rows
+ Paste transpose into a new sheet
+ Add description column

![img-center-100](../images/cluster_prep13.png)

---

#Prepare the data
+ Insert 5 columns
+ Name the columns `Cluster 1`, `Cluster 2`,...

![img-center-100](../images/cluster_prep14.png)

---

#Prepare the data
+ Add rows for the distance calculations to each cluster
+ Add row for the minimum distance
+ Add row for the assigned cluster

![img-center-60](../images/cluster_prep15.png)

---

#Calculating the Cluster Distances
![img](../images/dc1.png)

##`=SQRT(SUM((H$2:H$14-$C$2:$C$14)^2))`<br>Press `CTRL` + `SHIFT` + `ENTER`

###This is an [array formula](http://www.cpearson.com/excel/arrayformulas.aspx)
---

#Calculating the Cluster Distances
+ Do the same for the other clusters

###Cluster 2 -> `=SQRT(SUM((H$2:H$14-$D$2:$D$14)^2))`
###Cluster 3 -> `=SQRT(SUM((H$2:H$14-$E$2:$E$14)^2))`
###Cluster 4 -> `=SQRT(SUM((H$2:H$14-$F$2:$F$14)^2))`
###Cluster 5 -> `=SQRT(SUM((H$2:H$14-$G$2:$G$14)^2))`

##Press `CTRL` + `SHIFT` + `ENTER` after each one<br>They should all be the same value

---

#Calculate the minimum distance
![img-center-70](../images/cluster_prep16.png)

##`=MIN(H15:H19)`
---

#Select the assigned cluster
![img-center-70](../images/cluster_prep17.png)

##`=MATCH(H20,H15:H19,0)`
###[MATCH Function](https://support.office.com/en-US/article/MATCH-function-E8DFFD45-C762-47D6-BF89-533F4A37673A) (finds the cluster with the shortest distance)

---

#Copy and drag across all the cities
![img-center-50](../images/cluster_prep18.png)
--

+ Check that all the cluster distances are the same for a city
--

+ Every city should be assigned to cluster 1

---

#Calculate the sum of the minimum distances
![img-left-48](../images/cluster_prep19.png)
![img-right-48](../images/cluster_prep20.png)
#&nbsp;
<br>
<br>
<br>
<br>
+ This is what we want to minimize
--

+ Anyone want to figure this out by hand?

---

#Quick Recap
--

+ We created 13 features for 286 cities
--

+ We created a matrix for those values
--

+ We setup Excel to calculate the distance from each city to the cluster centers (initially 0,0)
--

+ We calculate the assigned cluster
--

+ We summed the minimum distance into a total distance measure

---

#Next Steps
--

+ We use Excel to find the minimum total distance by adjusting the center points of the clusters
--

+ We have to tell Excel where the values are
--

+ We have to set a simple constraint
--

+ We then just let it do it's thing

---

#Make sure Solver is enabled
![img-left-30](../images/datp_mac1.png)
![img-right-60](../images/datp_mac2.png)

---

#Setup Solver
+ Set the objective (minimize the total distance)

![img-center-90](../images/solver1a.png)

---

#Setup Solver
+ Select the cells to change (cluster centers)

![img-center-90](../images/solver1b.png)

---

#Setup Solver
+ Add constraints (cluster centers less than or equal to 1)
![img-center-60](../images/solver2a.png)
--

+ May need to do this first, then edit the constraint
![img-center-60](../images/solver3.png)

---

#Setup Solver
+ Change method to "Evolutionary", the select "Options"

![img-center-80](../images/solver4a.png)

---

#Setup Solver
![img-right-50](../images/solver5_box.png)
+ Increase the "Maximum Time without Improvement"

---

#Setup Solver
![img-right-50](../images/solver4.png)
+ It should look like this
--

+ Select "Solve"

---
class:center,middle
#10 Min Break
![img-center-50](http://imgs.xkcd.com/comics/compiling.png)

http://xkcd.com/303/

---

#Analyze the results
+ Yours will probably look different
+ Any patterns in the clusters?

![img-center-100](../images/ca1.png)

---

#Analyze the results - Cities by cluster
+ Create a new sheet
+ Copy the cities and descriptions
+ Add columns for each cluster with just the number

![img-center-100](../images/ca2.png)

---

#Analyze the results - Cities by cluster
+ We want to count the city that has the matching attribute
+ But only if it belongs to that cluster

![img-center-100](../images/ca3.png)

##`=SUMIF('5_Cluster'!$H$21:$KG$21,C$1,'5_Cluster'!$H13:$KG13)`
###Assumes the sheet is called "5_Cluster"

---

#Analyze the results - Cities by cluster
+ Copy the results to the rest of the cells
+ Add conditional formatting
+ What do you notice about the results?

![img-center-90](../images/ca4.png)
--

###You can also filter by the clusters to make it clearer

---

class:middle,center
#How do we feel about these clusters?

---

#Inspirational Thought
<!-- ![img-right-30](../images/algo_book.png) -->
> ##The validation of clustering structures is the most difficult and frustrating part of cluster analysis. 
> ###Algorithms for Clustering Data, Jain and Dubes

---

#Checking the results
--

+ The goal is to minimize the distance within clusters and maximize the distance between clusters
--

+ Cities shouldn't be closer to cities of another cluster than they are to cities of their own cluster
--

+ We can calculate that (called the silhouette)
--

+ Measures average distance to points in neighboring cluster subtracted by average distance to points in assigned cluster divided by the greater of those two
--

+ First we need to calculate distances

---

#Calculating Distances
+ Create a new sheet
+ Call it "Distances"
+ Copy the cities from the 5_Cluster sheet in the second row starting in the third column
+ Transpose the cities into the second column starting in the third row

---

#Calculating Distances
+ Add a 0 to the first row, third column above "AlbuquerqueNM"
+ Write a simple formula to increment and paste across
+ Do the same in the first column

![img-center-80](../images/ca5.png)

---

#Calculating Distances
+ Now we need to calculate the distance from every city to every other

###`=SQRT(SUM((OFFSET('5_Cluster'!$H$2:$H$14,0,Distances!C$1)-OFFSET('5_Cluster'!$H$2:$H$14,0,Distances!$A3))^2))`

+ This is the same type of formula we used to calculate the distance between each city and the cluster center
+ Now we're going to [OFFSET](https://support.office.com/en-us/article/OFFSET-function-c8de19ae-dd79-4b9b-a14e-b4d906d11b66) by the value in the index (starting with Albuquerque)

---

#Calculating Distances
+ Click and drag to calculate all the distances
+ Cities should have a 0 distance from themselves

![img-center-100](../images/ca6.png)

---

#Calculating the Silhouette
+ Create a new sheet
+ Paste the cities with their cluster assignments
+ Add columns for each cluster
+ Calculate the average distance from the city to cities in the other cluster, starting at the top left

###`=AVERAGEIF('5_Cluster'!$H$21:$KG$21,1,Distances!$C3:$KB3)`

---

#Calculating the Silhouette
+ Copy and paste across the sheet

![img-center-100](../images/ca7.png)

+ Add column "Closest" (to calculate the closest cluster)
+ Add column "Second Closest"

---

#Calculating the Silhouette
+ Calculate the closest cluster distance `=MIN(C2:G2)`
+ Calculate the second closest cluster `=SMALL(C2:G2,2)`

![img-center-100](../images/ca8.png)

+ Ideally the closest cluster is the assigned cluster, but that isn't always the case
 
---

#Calculating the Silhouette
+ Add column "Assigned Cluster"
+ Add formula `=INDEX(C2:G2,B2)`<br>(returns the distance for the assigned cluster using [INDEX](https://support.office.com/en-us/article/INDEX-function-a5dcf0dd-996d-40a4-a822-b56b061328bd))
+ Add column "Neighboring Cluster"
+ Add formula `=IF(J2=H2,I2,H2)`<br>(If the assigned cluster is the closest cluster, return the second cluster, else return the assigned cluster)

---

#Calculating the Silhouette
+ Add column "Silhouette Values"
+ Add formula `=K2-J2/MAX(K2,J2)`
+ Remember: Silhouette measures average distance to points in neighboring cluster (K2) subtracted by average distance to points in assigned cluster (J2) divided by the greater of those two

---

#Calculating the Silhouette
![img-center-60](../images/ca9.png)
--

+ Now take the average silhouette for each city to find the overall silhouette<br>`=AVERAGE(L2:L287)`
--
![img-right-30](../images/ca10.png)

---

#Things we can do to improve this
--

+ Change the number of clusters
--

+ Use different features
--

+ Change how we encode the features (Percent Rank instead of dummy variables or simple encodings)

---

#Takeaways
--

+ Similarity can be useful in comparing data points (in this case cities)
--

+ It's not an easy process and requires thought on how to measure what's important
--

+ Creating features can be tricky
--

+ Clustering doesn't always provide easily intelligible results
--

+ Often have to iterate multiple times to arrive at something meaningful

---

#Final thoughts
--

+ Check how your data is distributed
--

+ Don't be afraid to iterate with your data
--

+ Always check your formulas

---

#Thank You
+ [richard@datapolitan.com](mailto:richard@datapolitan.com)
+ http://blog.datapolitan.com
+ [@rdunks1](https://twitter.com/rdunks1)/[@datapolitan](https://twitter.com/Datapolitan)


   </textarea>
    <script src="https://gnab.github.io/remark/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create(
      // {
      //   slideNumberFormat: ""}
        );
    </script>
  </body>
</html>
