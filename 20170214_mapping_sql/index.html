<!DOCTYPE html>
<html>
  <head>
    <title>Mapping with SQL - Center for Government Excellence</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../slide.css"/>
  </head>
  <body>
    <textarea id="source">

layout:true

<p class="footer">
<span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Mapping with SQL - Center for Government Excellence</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://www.datapolitan.com" property="cc:attributionName" rel="cc:attributionURL">Richard Dunks</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative-Commons-License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>
</p>

---

class:center,middle

![img-center-40](../images/datapolitan.png)
# Mapping in SQL

- - - 

## Richard Dunks
### Follow along at: http://bit.ly/govex-mapping-sql
### Code available at: http://bit.ly/govex-mapping-sql-code

### [Day 2](#day2)

---

# Goals
--

+ Introduce basic spatial concepts
--

+ Introduce the use of a spatial database
--

+ Introduce SQL for querying data, including spatial data

---

# Outcomes
--

+ You will feel more comfortable with GIS concepts
--

+ You will be more familiar with using QGIS
--

+ You will understand the purpose of spatial databases
--

+ You will have an understanding of the fundamentals of SQL
---

# Installing QGIS
+ [Download the version for your system](http://www.qgis.org/en/site/forusers/download.html)
+ Go ahead and download `version 2.18`

---

name:spatial_elements
class:center,middle
# Basic Spatial Elements

---

# Points  
![img-center-50](images/point_feature.png)
####Source: http://docs.qgis.org/2.8/en/docs/gentle_gis_introduction/vector_data.html#overview

---

# Lines
![img-center-50](images/polyline_feature.png)
####Source: http://docs.qgis.org/2.8/en/docs/gentle_gis_introduction/vector_data.html#overview

---

# Polygons
![img-center-50](images/polygon_feature.png)
####Source: http://docs.qgis.org/2.8/en/docs/gentle_gis_introduction/vector_data.html#overview

---

name:gis
class:center,middle
# So What is a GIS?

---

# Geographic Information System (GIS)
> Any system for capturing, storing, checking, and displaying data related to positions on the Earth's surface

+ [National Geographic Education Encyclopedia](http://education.nationalgeographic.org/encyclopedia/geographic-information-system-gis/)

---

# Or more simply

> In a GIS, you connect _**data**_ with _**geography**_.

+ [GISgeography.com](http://gisgeography.com/what-gis-geographic-information-systems/)

---

# Geographic Information Systems (GIS)
--

+ Create interactive queries (user-created searches)
--

+ Analyze spatial information
--

+ Edit data in maps
--

+ Present the results of all these operations

---

class:center,middle
# Let's make a map
![img-center-80](images/p1_finished.png)

---

name:basemap
# Base Maps 
--

+ Adding base maps will give your map context
--

+ In QGIS, you need a plugin to use base maps
--

+ There are several, but we're only going to use one of them

---

# Base Map Plugin
+ From the Plugins menu, select "Manage and Install Plugins"

![img-center-60](images/basemap2.png)

---

# Base Map Plugin

+ Search for the QuickMapServices plugin and install it

![img-center-75](images/basemap3_box.png)

---

# Setting Up QuickMapServices Plugin
+ Go to the Settings Menu
![img-center-80](images/basemap4.png)

---

# Setting Up QuickMapServices Plugin
+ Get the contributed packs
![img-center-80](images/basemap5_box.png)

---

# Setting Up QuickMapServices Plugin
![img-right-45](images/basemap6_trim.png)
+ Revel in all the beautiful base maps

---

# Select a base map from the list
![img-center-80](images/p1_basemap.png)

---

# Adding Layers
![img-center-100](images/map1.png)
#### Image Source: http://www.geocontrolling.com/co-je-gis.htm

---

name:shapefile
# Shapefiles
--
        
+ Basic file for storing map elements
--

+ Stores spatial data, like points, lines, and polygons
--

+ Multiple files comprise a "shapefile"

--

![img-center-80](images/file_struct1.png)

---

# Download a shapefile and import
1. [Click this link](data/boros.zip) and download the file to your desktop
2. Unzip the file


![img-center-80](images/qgis_nav2.png)
---

# Import a shapefile

![img-center-50](images/qgis_nav3_box.png)

![img-center-55](images/qgis_nav4.png)

---

# Import a shapefile
![img-center-80](images/p1_boro_shp.png)

---
name:csv
class:center,middle
# Adding a CSV file

---

# What is a CSV?
--

![img-center-100](images/csv_311_ex.png)

---

# Import a CSV
+ [Right click this link](data/dot_311_20160201_20160207.csv)
+ Select "Save link as" 
+ Save the file (`dot_311_20160201_20160207.csv`) to your desktop

---

# Adding CSV Data
![img-center-70](images/add_csv1.png)

![img-center-90](images/add_csv2_box_crop.png)

---

# Adding CSV Data
![img](images/p1_csv_box.png)

---

# Adding CSV Data
![img](images/add_csv5.png)

---

name:projections
class:center,middle
# What is a Coordinate Reference System?

---

# Projections
--

+ No one's favorite part of GIS
--

+ But a necessary part of it nonetheless
--

+ Convert points on the 3-dimensional Earth (**latitude** and **longitude**) to x and y coordinates on a 2-dimensional map

--

![img-center-85](images/projections-orange.jpg)

[Digital Coast Geozone](https://geozoneblog.wordpress.com/2012/05/22/happy-birthday-mercator/)

---

# Projections
+ Every projection distorts some part of your map

![img-center-50](images/projections-faces.png)

[FlowingData](http://flowingdata.com/2014/01/13/map-projections-illustrated-with-a-face/)

---

# Projections

+ For the most part we will work in **WGS 84** (latitude and longitude)
--

+ In NYC, we use a more accurate projection **NY State Plane/Long Island Zone**
![img-right-60](images/projections_NYSplane.png)

###### Source: https://alidade.wikispaces.com/New+York+SPCS+Zones

---

# Projections
![img-right-35](https://alidade.wikispaces.com/file/view/MO%20zones.GIF/442304008/512x456/MO%20zones.GIF)
+ Each state has it's own [state plane system](http://archives.profsurv.com/magazine/article.aspx?i=1180)
+ Cities, counties, and other municipalities generally use the zone that covers their area
+ Some are more established than others
+ Often municipalities [don't explicitly state the projection they're using](http://gis.stackexchange.com/a/88442/16883)
+ Most use `feet`, but also have versions that use `meters`

---

# Projections
+ Identified by unique IDs that make it easier to talk about them
--

+ WGS 84 is referred to as **EPSG:4326**
--

+ NYS State Plane Long Island is referred to as **EPSG:2263**
--

## These are the two we'll be using today

---

# Adding CSV Data
![img-center-55](images/add_csv6_box.png)

---

# Adding CSV Data
![img-center-80](images/p1_points_poly.png)

---

name:styling
class:center,middle
# Styling the map

---

#Attribute Table (Right click on layer)
![img-left-40](images/qgis_nav6_crop.png)
![img-right-55](images/qgis_nav7.png)

---

#Styling Features
+ Right-click the layer and select the Properties option
+ Select "Style," and finally, choose "Categorized":
        
![img-90](images/styling1.png)

---

# Styling Features
+ Select the column that has the data you want to style:
    
![img-center-60](images/styling2.png)

![img](images/styling3_box.png)

---

# Styling Features
![img](images/styling4_box.png)

---

# Styling Features
![img-center-80](images/p1_style.png)

---

#Your turn
+ Style the points and polygons however you'd like
+ Try adding labels to the data
+ Get familiar with the interface

---

exclude:true 

class:middle,center

# 5 Min Break
![img-center-50](https://scontent-lga3-1.cdninstagram.com/t51.2885-15/s480x480/e35/12277599_1650021651913770_1349530766_n.jpg)

###Source: https://www.instagram.com/p/-0QkhTj82O/
---
name:database
class:center,middle
#Spatial Databases

---

#What is a database?

--
![img-center-90](images/databases.jpg)
#####Source: http://blog.hackerrank.com/new-domain-tuesday-hackerrank-reveals-data-structure-database-sql-challenges/

---

#What is a database?

> An organized collection of data.

##[Wikipedia](https://en.wikipedia.org/wiki/Database)
---

#What is a database?

> A set of data that has a regular structure and that is organized in such a way that a computer can easily find the desired information.

##[The Linux Information Project](http://www.linfo.org/database.html)

---

#What is a database?
+ Another source of data
--

+ A program that often runs on a computer other than the one you're using (a server)
--

+ You can connect to databases through many types of software, including QGIS

---

# What is a spatial database?
--

+ A database that stores spatial features
--

+ Optimized for processing spatial data, especially location-aware queries
--

+ Both a storage and analysis tool
--

![img](http://presentations.opengeo.org/2011_IMAK/Workshop_OpenSource_Stack/_images/spatialmojo.png)

#### Source: http://presentations.opengeo.org/2011_IMAK/Workshop_OpenSource_Stack/postgis/spatialdbs.html

---

# Let's connect to a spatial database
![img-center-70](images/add_pg_layer1.png)

--

![img-center-65](images/add_pg_layer2_box_crop.png)

---

# Let's connect to a spatial database
![img-right-40](images/add_pg_layer3_box.png)
+ Name: (Whatever you'd like)
+ Host: `training.c1erymiua9dx.us-east-1.rds.amazonaws.com`
+ Port: `5432`
+ Database: `training`
+ Username: `gis_student`
+ Password: `qgis`
--

![img-center-35](images/add_pg_layer4.png)

---

# Let's connect to a spatial database
![img-left-45](images/add_pg_layer5_box.png)
![img-right-45](images/add_pg_layer6_box.png)
#### &nbsp;
#### &nbsp;
#### &nbsp;
#### &nbsp;
#### &nbsp;
#### &nbsp;
#### &nbsp;
### Now it's just like any other data source we've been using

---

# Exercise - Selecting Injuries in a Borough
1. Add the `injuries` table to your map
2. Right click and select "Filter..."
![img-right-40](images/filter_pg_layer1.png)
3. Select `borough` and query for your borough

#####&nbsp;
![img-left-60](images/filter_pg_layer2_crop.png)

---

# Selecting Injuries in a Borough
![img-center-60](images/filter_pg_layer3.png)

---

# Save Selection As Shapefile
![img-left-40](images/save_filter1.png)
![img-right-55](images/save_filter2.png)

---

# Let's talk datatypes

--

![img-center-80](images/qgis_nav7.png)

--

+ In the attribute table you will usually see *text*, *numbers*, and *dates*

---

# Let's talk datatypes

![img-center-80](images/qgis_attribute_table_number.png)

--

## Numbers will be right aligned

---

# Let's talk datatypes

![img-center-80](images/qgis_attribute_table_string.png)

--

## Text will be left aligned

---

# Database datatypes

--

+ Like attribute tables, database columns have types
--

+ Numbers, text (*strings*), and dates are the main types
--

+ Spatial databases add *geometry* columns
--

+ Geometry columns let us map our data

---

# Why use a spatial database?

--

+ One authoritative copy of data
--

+ Multiple people can use and edit it at once
--

+ Generally is going to be faster than using a shapefile

---

# Drawbacks of using a spatial database

--

+ Not as simple as a CSV file or shapefile
--

+ It takes some setup to connect to a database
--

+ Need permission to connect to a database
--

+ Need to know SQL to get the most out of it

---

name:day2

class:center,middle
# Day 2
# Welcome Back

---

# What We Covered Yesterday
--

+ [Basic Spatial Elements](#spatial_elements)
--

+ [What is a GIS?](#gis)
--

+ [Adding a Basemap](#basemap)
--

+ [Adding Shapefiles](#shapefile)
--

+ [Adding CSV data](#csv)
--

+ [Projections](#projections)
--

+ [Styling features](#styling)
--

+ [Connecting to a database](#database)

---

# Back to databases

![img-center-90](images/databases.jpg)

---

![img-center-80](images/paper-stack.jpg)

---

# You might ask:

![img-right-30](images/paper-stack.jpg)

+ Which pages refer to properties in Brooklyn?
--

+ Which pages refer to properties in Brooklyn that have been built on since 1950?
--

+ What are the addresses of those properties?

---

# Databases are great at questions like these
--

+ It's what they were made for
--

+ SQL will let us ask these questions

---

# SQL
--

+ Structured Query Language
--

+ The language databases understand
---

# SQL queries
--

+ Can *view* data
--

+ and *change* data
--

## We're going to stick to *viewing* data

---

# SQL looks like:

```sql
SELECT *
FROM injuries
```
--

+ In english: "select all the injuries"

--

```sql
SELECT *
FROM injuries
WHERE borough = 'QUEENS'
```
--

+ In english: "select all the injuries in Queens"

---

# You can combine conditions

```sql
SELECT *
FROM injuries
WHERE borough = 'QUEENS' AND contributi = 'Fatigued/Drowsy'
```

--

```sql
SELECT *
FROM injuries
WHERE contributi = 'Outside Car Distraction' OR contributi = 'Fatigued/Drowsy'
```

---

# This should feel pretty familiar
--

![img-center-60](images/filter1.png)

---

class:center,middle
# Let's use SQL in QGIS

---

# DB Manager
--

+ One way to see your database *connections* and *tables*
--

+ Also a way to run SQL queries on your tables

---

# DB Manager
--

![img-center-45](images/db_manager_menu.png)

---

# DB Manager
![img-center-90](images/db_manager.png)

---

# DB Manager
![img-center-90](images/db_manager_schema.png)

---

# DB Manager
![img-center-90](images/db_manager_injuries.png)

---

# DB Manager
![img-center-90](images/db_manager_open_sql_window.png)

---

# DB Manager
![img-center-90](images/db_manager_sql_window.png)

---

# Simple SQL Query
![img-center-90](images/db_manager_queens.png)

---

# Simple SQL Query
![img-center-90](images/db_manager_queens_execute_button.png)

---

# Simple SQL Query
![img-center-90](images/db_manager_queens_execute.png)

---

# Add Query Result to Map
![img-center-90](images/db_manager_queens_execute_load_new_layer_checkbox.png)

---

# Add Query Result to Map
![img-center-90](images/db_manager_load_as_new_layer.png)

---

# Add Query Result to Map
![img-center-90](images/db_manager_load_as_new_layer_load_button.png)

---

# Add Query Result to Map
![img-center-80](images/injuries_queens.png)

---

# Your turn
+ Use DB Manager and SQL to select the injuries for the Bronx
+ Add the results as a layer in QGIS

---

class:center,middle
# How Do We Do Joins in SQL?

---

class:center.middle
![img-center-95](images/sql_join1.png)

http://stackoverflow.com/questions/406294/left-join-and-left-outer-join-in-sql-server

---

# Let's Try an Example
![img-center-60](images/borough_injury_join.png)

---

# Questions to Ask
+ What tables are we going to use?
--
<br>(`nyc_boro` and `boro_injury_count`)
--

+ What kind of join do we want to do?
--

+ What values are we going to join on?
---

class:center,middle
# Try to Write the Query Yourself

---

# Example Query
```sql
SELECT b.*, bc.injury_count
FROM nyc_boro AS b
INNER JOIN boro_injury_count AS bc
  ON b.borocode = bc.borough_code
```
--
- - -
```sql
FROM nyc_boro AS b
```
+ Using the table `nyc_boro` table, which [we're aliasing](https://www.techonthenet.com/postgresql/alias.php) as `b`

---

# Example Query
```sql
SELECT b.*, bc.injury_count
FROM nyc_boro AS b
INNER JOIN boro_injury_count AS bc
  ON b.borocode = bc.borough_code
```

- - -
```sql
INNER JOIN boro_injury_count AS bc
```
+ [`INNER JOIN`](http://www.postgresqltutorial.com/postgresql-inner-join/) the `boro_injury_count` table, which we're aliasing as `bc`

---

# Example Query
```sql
SELECT b.*, bc.injury_count
FROM nyc_boro AS b
INNER JOIN boro_injury_count AS bc
  ON b.borocode = bc.borough_code
```

- - -
```sql
ON b.borocode = bc.borough_code
```
+ We joining `borocode` from `nyc_boro` to `borough_code` from `boro_injury_count`
---

# Example Query
```sql
SELECT b.*, bc.injury_count
FROM nyc_boro AS b
INNER JOIN boro_injury_count AS bc
  ON b.borocode = bc.borough_code
```

- - -
```sql
SELECT b.*, bc.injury_count
```
+ We're selecting all the columns from `nyc_boro` and the `injury_count` column from `boro_injury_count`

---

#Spatial Join

![img-right-30](images/join1.png)

--

##Point to Polygon
+ Relate points inside a polygon to that polygon (ex. count the number of points)

--

##Polygon to Point 
+ Points can take on value of enclosing polygon

---

#Spatial joins in SQL
--

+ Let's do a simple points in polygon join:

--

```sql
SELECT nyc_boro.*, COUNT(injuries)
FROM nyc_boro
INNER JOIN injuries ON ST_Within(injuries.geom, nyc_boro.geom)
GROUP BY nyc_boro.gid
```

---

#Line by line:

```sql
SELECT nyc_boro.*, COUNT(injuries)
```

##"Select all of the `nyc_boro` columns and the count of `injuries`"

---

#Line by line:

```sql
FROM nyc_boro
```

##"Use the `nyc_boro` table"

---

#Line by line:

```sql
INNER JOIN injuries ON ST_Within(injuries.geom, nyc_boro.geom)
```

## "Join with `injuries`, associate `injuries` with the `nyc_boro` they are within"

---

# Line by line:

```sql
GROUP BY nyc_boro.gid
```

## "Count by borough"

---

## All together:

```sql
SELECT nyc_boro.*, COUNT(injuries)
FROM nyc_boro
INNER JOIN injuries ON ST_Within(injuries.geom, nyc_boro.geom)
GROUP BY nyc_boro.gid
```

--

## More generally:

```sql
SELECT polygons.*, COUNT(points)
FROM polygons
INNER JOIN points ON ST_Within(points.geom, polygons.geom)
GROUP BY polygons.unique_id
```

--

### Just replace *points* and *polygons* with the table names, *unique_id* with a unique id from your polygons table

---

# Joining Tables in SQL
![img-center-90](images/db_manager_join.png)

---

# Joining Tables in SQL
![img-center-90](images/db_manager_join_results.png)

---

# Joining Tables in SQL
![img-center-90](images/spatial_join_attribute_table.png)

---

# `ST_Within`

--

+ A *spatial* SQL function
--

+ Similar to other SQL conditions (`borough = 'QUEENS'`)
--

+ ...but we're checking whether the geometries of one table are *within* geometries from another

---

# `ST_Within`

![img-center-40](images/st-within.gif)
#####Source: https://www.ibm.com/support/knowledgecenter/SSGU8G_11.50.0/com.ibm.spatial.doc/relation1033234.htm%23relation1033234

---

# Spatial SQL functions

--

+ There are many more you can use
--

+ For example, `ST_Crosses`:

![img-center-40](images/st-crosses.png)

---

# Spatial SQL functions

--

+ We're only covering `ST_Within` today
--

+ But we will give you resources for finding other spatial SQL functions

---

# Finishing
+ Add the result to the table
+ Style the values (3 classes)

---

class:center,middle
# Resources for Working with Spatial Data

---

class:center,middle
# Resources

---

# GIS Stack Exchange

![img-center-90](images/gis-stackexchange.png)

[GIS Stack Exchange](http://gis.stackexchange.com/)

---

# Learning QGIS

![img-center-40](images/learning-qgis.png)

[Learning QGIS](https://www.packtpub.com/application-development/learning-qgis-20)

---

# QGIS Map Design

![img-center-40](images/qgis-map-design.png)

[QGIS Map Design](http://locatepress.com/qmd)

---

# PostGIS in Action

![img-center-40](http://ecx.images-amazon.com/images/I/5172NoQsEcL._SX397_BO1,204,203,200_.jpg)

[PostGIS in Action](http://www.postgis.us/)

---

# The PostGIS Documentation
![img](images/postgis_docs.png)

http://postgis.net/documentation

---

# The PostGIS Documentation
[![img](images/st_within_docs.png)](http://postgis.net/docs/ST_Within.html)

### They're actually really helpful

---

# Other Documentation
+ [QGIS online manual](http://docs.qgis.org/2.8/en/docs/)
+ [QGIS Tutorials and Tips](http://www.qgistutorials.com/en/index.html)
+ [Free and Open Source GIS Ramblings](https://anitagraser.com/)

---

# Get Projection from a .prj file
[![img-center-80](images/prj2epsg.png)](http://prj2epsg.org/search)

---

class:middle
[![img-full](images/cartodb_qgis.png)](http://blog.cartodb.com/qgis-plugin/)

---

# Reminders
--

+ Know your layer projection
--

+ Always test your queries when you filter
--

+ Use descriptive filenames
--

+ Keep your data organized
--

+ Save your work often (especially your project file)
--

+ When in doubt, save, close, and restart

---

# Things we didn't cover
--

+ [Buffering](http://www.datapolitan.com/DOT_GIS/20160610_Intermediate_GIS/#193)
--

+ [Select by Location](http://www.datapolitan.com/DOT_GIS/20160610_Intermediate_GIS/#229)
--

+ [Heatmaps](http://www.datapolitan.com/DOT_GIS/20160610_Intermediate_GIS/#380)
--

+ [Geocoding](http://www.datapolitan.com/DOT_GIS/20160610_Intermediate_GIS/#403)
--

+ [Print Composer](http://www.datapolitan.com/DOT_GIS/20160428_Introduction_to_GIS_Fundamentals/#246)

---

#Thank You
[![img-right-40](https://scontent-lga3-1.cdninstagram.com/l/t51.2885-15/e35/11260589_1537702966519640_1758757795_n.jpg)](https://scontent-lga3-1.cdninstagram.com/l/t51.2885-15/e35/11260589_1537702966519640_1758757795_n.jpg)
+ [richard(at)datapolitan(dot)com](mailto:richard@datapolitan.com)
+ http://blog.datapolitan.com
+ [@rdunks1](https://twitter.com/rdunks1)/[@datapolitan](https://twitter.com/Datapolitan)


   </textarea>
    <script src="https://gnab.github.io/remark/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create(
        {
      //   slideNumberFormat: ""
          countIncrementalSlides: false
        }
        );
    </script>
  </body>
</html>
